COMMON = ..

# compiler
CC = xlc
CFLAGS = -S -qmetal -q64 -qnoinline -DSUBPOOL=230 -DMETTLE=1 -DMSGPREFIX='"TST"' \
         -DCMS_CLIENT -DCUSTOM_CONTEXT_GETTER -DNOIBMHTTP -qmakedep \
         -Wc,'arch(8),roconst,agg,exp,list(),so(),off,xref,roconst,longname,lp64' \
         -qreserved_reg=r12 -qnosearch -I/usr/include/metal -I/usr/include

# includes
INCLUDES = -I$(COMMON)/h

# sources
OBJS=alloc.o \
     crossmemory.o \
     metalio.o \
     qsam.o \
     recovery.o \
     timeutls.o \
     utils.o \
     zos.o \
     zvt.o \
     srb_test.o

METAL_ASM = $(OBJS:.o=.s)

# disable built-in rules
MAKEFLAGS += --no-builtin-rules

# rule so assembler *.s sources are not implicitly deleted
.PRECIOUS: $(METAL_ASM)

# assembler
AS = as
ASFLAGS = -mgoff -mobject --RENT --"OPTABLE(ZS6)" -aegms

# linker/binder
LD = ld
LDFLAGS  = -V -b rent -b case=mixed -b map -b xref -b reus,ac=1
LDFLAGSR = -S "//'SYS1.CSSLIB'"

# PDS(E) load library
LOADLIB = ${USER}.DEV.LOADLIB

# default rule
all: srb_test

# compilations
%.s : %.c
	$(CC) $(CFLAGS) $(INCLUDES) $<

# assembles
%.o : %.s
	$(AS) $(ASFLAGS) -o $@ $< >$(<:.s=.asmlst)

# links
srb_test: $(OBJS)
	$(LD) $(LDFLAGS) $(LDFLAGSR) -e main -o $@ $(OBJS) $(DEPS) > $@.lnklst || { rm -f $@; exit 1; }
	extattr +a $@ 

# cleanup rules
clean:
	rm -f *.o *.lst *.asmlst *.lnklst *.u srb_test $(METAL_ASM)

# include dependency side files generated by -qmakedep
-include $(OBJS:%.o=%.u)
